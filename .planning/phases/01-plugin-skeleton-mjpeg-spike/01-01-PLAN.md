---
phase: 01-plugin-skeleton-mjpeg-spike
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - manifest.json
  - Main.qml
  - BarWidget.qml
  - Panel.qml
  - Settings.qml
autonomous: true
requirements:
  - BAR-01
  - BAR-03

must_haves:
  truths:
    - "Camera (CCTV) icon is visible in the Noctalia bar after plugin installation"
    - "Clicking the bar icon opens the floating panel; clicking again dismisses it"
    - "Icon opacity changes when panel is open vs closed (active state feedback)"
    - "Hovering the bar icon shows tooltip: Frigate Viewer - Connected"
  artifacts:
    - path: "manifest.json"
      provides: "Plugin identity, entry points, defaultSettings schema"
      contains: "noctalia-frigate"
    - path: "Main.qml"
      provides: "State hub stub satisfying plugin contract"
      min_lines: 5
    - path: "BarWidget.qml"
      provides: "Bar icon with CCTV icon, active state, tooltip, panel toggle"
      min_lines: 40
    - path: "Panel.qml"
      provides: "Panel stub with placeholder text (MJPEG spike added in Plan 02)"
      min_lines: 10
    - path: "Settings.qml"
      provides: "Settings stub with placeholder text"
      min_lines: 5
  key_links:
    - from: "BarWidget.qml"
      to: "pluginApi.togglePanel"
      via: "MouseArea.onClicked"
      pattern: "pluginApi.*togglePanel"
    - from: "BarWidget.qml"
      to: "TooltipService"
      via: "MouseArea.onEntered"
      pattern: "TooltipService\\.show"
    - from: "manifest.json"
      to: "all QML files"
      via: "entryPoints object"
      pattern: "entryPoints"
---

<objective>
Scaffold the Frigate Viewer plugin file structure and implement the BarWidget with CCTV icon, active state highlight, tooltip, and panel toggle.

Purpose: Establish the plugin skeleton so it loads in Noctalia bar with a clickable camera icon that opens/closes the panel. This is the foundation every other phase builds on.
Output: Five QML/JSON files that register a working plugin with a functional bar icon and stub panel/settings.
</objective>

<execution_context>
@/home/mariostjr/.claude/get-shit-done/workflows/execute-plan.md
@/home/mariostjr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-plugin-skeleton-mjpeg-spike/01-RESEARCH.md
@.planning/phases/01-plugin-skeleton-mjpeg-spike/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manifest.json and stub QML files (Main.qml, Settings.qml)</name>
  <files>manifest.json, Main.qml, Settings.qml</files>
  <action>
Create `manifest.json` in the project root with the following exact fields (per locked decisions from CONTEXT.md):

```json
{
  "id": "noctalia-frigate",
  "name": "Frigate Viewer",
  "version": "1.0.0",
  "minNoctaliaVersion": "4.4.0",
  "author": "pir0c0pter0",
  "license": "MIT",
  "repository": "https://github.com/pir0c0pter0/noctalia-frigate",
  "description": "Live camera viewer for Frigate NVR",
  "tags": ["Bar", "Panel"],
  "entryPoints": {
    "main": "Main.qml",
    "barWidget": "BarWidget.qml",
    "panel": "Panel.qml",
    "settings": "Settings.qml"
  },
  "dependencies": {
    "plugins": []
  },
  "metadata": {
    "defaultSettings": {
      "frigateUrl": "",
      "username": "",
      "password": "",
      "selectedCameras": [],
      "cameraOrder": []
    }
  }
}
```

Create `Main.qml` as a minimal stub satisfying the plugin contract:
```qml
import QtQuick

Item {
    id: root
    property var pluginApi: null

    // Phase 1 stub - state hub implemented in Phase 3
}
```

Create `Settings.qml` as a placeholder:
```qml
import QtQuick
import qs.Widgets

Item {
    property var pluginApi: null

    NText {
        anchors.centerIn: parent
        text: "Settings coming in Phase 2"
    }
}
```

IMPORTANT: The manifest `id` field MUST be "noctalia-frigate" and MUST match the plugin directory name when installed. All entry point file names MUST match the actual QML filenames exactly.
  </action>
  <verify>
Verify all three files exist and are valid:
- `cat manifest.json | python3 -m json.tool` succeeds (valid JSON)
- manifest.json contains `"id": "noctalia-frigate"` and all four entryPoints
- Main.qml contains `property var pluginApi: null`
- Settings.qml contains `property var pluginApi: null`
  </verify>
  <done>manifest.json has correct plugin identity and all entry points; Main.qml and Settings.qml are valid stubs that satisfy the plugin contract</done>
</task>

<task type="auto">
  <name>Task 2: Implement BarWidget.qml with CCTV icon, active state, tooltip, and panel toggle</name>
  <files>BarWidget.qml, Panel.qml</files>
  <action>
Create `BarWidget.qml` following the niri-auto-tile raw Item pattern (per locked decision from CONTEXT.md). The BarWidget must implement:

1. **Required properties** (plugin contract):
   - `property var pluginApi: null`
   - `property ShellScreen screen`
   - `property string widgetId: ""`
   - `property string section: ""`
   - `property int sectionWidgetIndex: -1`
   - `property int sectionWidgetsCount: 0`

2. **CCTV icon** (BAR-01):
   - Use `NIcon { name: "camera-cctv" }` centered in a `Rectangle` capsule (per locked decision: security camera style icon)
   - If `NIcon` does not accept `name:`, try `icon: "camera-cctv"` as fallback (see Pitfall 4 in RESEARCH.md)
   - Capsule uses `Style.getCapsuleHeightForScreen(screenName)` for sizing
   - Capsule uses `Style.capsuleColor`, `Style.capsuleBorderColor`, `Style.capsuleBorderWidth`, `Style.radiusL` for theming
   - Hover state: `Color.mHover` when `mouseArea.containsMouse`

3. **Active state highlight** (per locked decision):
   - NIcon opacity: `1.0` when panel is open, `0.7` when closed
   - Read panel state from `pluginApi?.isPanelOpen ?? false`
   - Fallback: If `pluginApi.isPanelOpen` does not exist at runtime, track locally with `property bool panelOpen: false` toggled in onClicked (see Pitfall 3 in RESEARCH.md). For now, implement using `pluginApi?.isPanelOpen` and document the fallback.

4. **Tooltip** (per locked decision):
   - On `MouseArea.onEntered`: `TooltipService.show(root, "Frigate Viewer — Connected", BarService.getTooltipDirection(root))`
   - Phase 1: static text. Phase 3 will make it dynamic with real connection status.
   - On `MouseArea.onExited`: `TooltipService.hide()`

5. **Panel toggle** (BAR-03):
   - On `MouseArea.onClicked`: `pluginApi.togglePanel(root.screen, root)`
   - Do NOT use `pluginApi.openPanel()` (anti-pattern: does not close on second click)

Required imports:
```
import QtQuick
import QtQuick.Layouts
import Quickshell
import qs.Commons
import qs.Widgets
import qs.Services.UI
```

Also create `Panel.qml` as a temporary stub (Plan 02 will replace with MJPEG spike):
```qml
import QtQuick
import qs.Widgets

Item {
    id: root
    property var pluginApi: null
    property ShellScreen screen

    width: 640
    height: 400

    NText {
        anchors.centerIn: parent
        text: "Panel stub — MJPEG spike in Plan 02"
    }
}
```

Include `import Quickshell` in Panel.qml for the `ShellScreen` type.

NO hardcoded colors anywhere. All colors from `Color.*` or `Style.*` tokens.
  </action>
  <verify>
Verify BarWidget.qml implementation:
- File contains `name: "camera-cctv"` (or `icon: "camera-cctv"`)
- File contains `pluginApi.togglePanel(root.screen, root)` or `pluginApi?.togglePanel(root.screen, root)`
- File contains `TooltipService.show` and `TooltipService.hide`
- File contains `isPanelOpen` opacity binding
- File does NOT contain any hex color values (grep for `#[0-9a-fA-F]`)
- Panel.qml contains `property var pluginApi: null` and `property ShellScreen screen`
  </verify>
  <done>BarWidget.qml renders a CCTV icon in the bar with hover color change, opacity-based active state, tooltip on hover, and panel toggle on click. Panel.qml is a valid stub with correct dimensions.</done>
</task>

</tasks>

<verification>
After both tasks:
1. All five files exist in project root: manifest.json, Main.qml, BarWidget.qml, Panel.qml, Settings.qml
2. manifest.json is valid JSON with correct id, name, author, entryPoints
3. BarWidget.qml has all required properties (pluginApi, screen, widgetId, section, sectionWidgetIndex, sectionWidgetsCount)
4. No hardcoded color values in any QML file (grep for hex patterns)
5. BarWidget.qml references pluginApi.togglePanel (not openPanel)
</verification>

<success_criteria>
- Five plugin files exist and are syntactically valid
- Bar icon uses the camera-cctv Tabler icon with theme-compliant colors
- Panel opens on bar icon click and closes on second click (via togglePanel)
- Icon opacity changes based on panel open/close state
- Tooltip displays "Frigate Viewer - Connected" on hover
</success_criteria>

<output>
After completion, create `.planning/phases/01-plugin-skeleton-mjpeg-spike/01-01-SUMMARY.md`
</output>
