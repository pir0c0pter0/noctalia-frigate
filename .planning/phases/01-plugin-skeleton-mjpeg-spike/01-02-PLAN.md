---
phase: 01-plugin-skeleton-mjpeg-spike
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - Panel.qml
autonomous: false
requirements:
  - VIEW-01

must_haves:
  truths:
    - "A hardcoded MJPEG stream URL displays a live video frame in the panel"
    - "The stream visually updates over 30+ seconds (not a frozen first frame)"
    - "Setting source to empty then reassigning URL reconnects the stream"
    - "The spike result (go/no-go) is documented for Phase 4 to reference"
  artifacts:
    - path: "Panel.qml"
      provides: "MJPEG spike with Image component, reconnect test button, status logging"
      contains: "cache: false"
      min_lines: 40
    - path: ".planning/phases/01-plugin-skeleton-mjpeg-spike/01-SPIKE-RESULT.md"
      provides: "Go/no-go documentation of MJPEG behavior on target platform"
      min_lines: 10
  key_links:
    - from: "Panel.qml"
      to: "Frigate MJPEG endpoint"
      via: "Image.source URL"
      pattern: "source:.*api.*camera"
    - from: "Panel.qml"
      to: "reconnectTimer"
      via: "source = empty then Timer reassignment"
      pattern: "reconnectTimer"
---

<objective>
Implement the MJPEG streaming spike in Panel.qml to validate that Qt6's Image component can display a continuous MJPEG stream from Frigate, then verify visually with the user and document the go/no-go result.

Purpose: This spike resolves the single largest technical unknown before any viewer UI is built around it. The result determines whether Phase 4 uses MJPEG streaming or falls back to snapshot polling.
Output: Panel.qml with working MJPEG spike; spike result documentation.
</objective>

<execution_context>
@/home/mariostjr/.claude/get-shit-done/workflows/execute-plan.md
@/home/mariostjr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-plugin-skeleton-mjpeg-spike/01-RESEARCH.md
@.planning/phases/01-plugin-skeleton-mjpeg-spike/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MJPEG spike in Panel.qml</name>
  <files>Panel.qml</files>
  <action>
Replace the Panel.qml stub (created in Plan 01) with the MJPEG spike implementation. The spike tests three behaviors documented in RESEARCH.md:

1. **First frame display** — Does `Image { source: mjpegUrl; cache: false }` render at all?
2. **Continuous streaming** — Does the image update over 30+ seconds, or freeze on the first frame?
3. **Reconnect** — After `source = ""` + Timer delay + reassignment, does the stream resume?

Implementation:

```qml
import QtQuick
import Quickshell
import qs.Commons
import qs.Widgets

Item {
    id: root
    property var pluginApi: null
    property ShellScreen screen

    // SPIKE: Replace with your actual Frigate host and camera name
    // Format: http://FRIGATE_HOST:5000/api/CAMERA_NAME?fps=5
    // Example: http://192.168.1.100:5000/api/front_door?fps=5
    readonly property string spikeUrl: "http://FRIGATE_HOST:5000/api/CAMERA_NAME?fps=5"

    width: 640
    height: 400

    Rectangle {
        anchors.fill: parent
        color: Color.mSurface

        Image {
            id: streamView
            anchors.fill: parent
            anchors.margins: 4
            source: root.spikeUrl
            cache: false
            fillMode: Image.PreserveAspectFit

            onStatusChanged: {
                if (status === Image.Ready) {
                    spikeLog.text = "[spike] Frame loaded — status: Ready\n" + spikeLog.text
                } else if (status === Image.Error) {
                    spikeLog.text = "[spike] Stream ERROR\n" + spikeLog.text
                } else if (status === Image.Loading) {
                    spikeLog.text = "[spike] Loading...\n" + spikeLog.text
                }
            }
        }

        // Spike status log (visible in panel for debugging)
        NText {
            id: spikeLog
            anchors.bottom: reconnectButton.top
            anchors.left: parent.left
            anchors.right: parent.right
            anchors.margins: 8
            text: "[spike] Waiting for stream..."
            wrapMode: Text.Wrap
            opacity: 0.7
        }

        // Reconnect test button
        Rectangle {
            id: reconnectButton
            anchors.bottom: parent.bottom
            anchors.horizontalCenter: parent.horizontalCenter
            anchors.bottomMargin: 8
            width: reconnectLabel.width + 24
            height: reconnectLabel.height + 12
            color: Color.mPrimary
            radius: Style.radiusM

            NText {
                id: reconnectLabel
                anchors.centerIn: parent
                text: "Test Reconnect"
                color: Color.mOnPrimary
            }

            MouseArea {
                anchors.fill: parent
                cursorShape: Qt.PointingHandCursor
                onClicked: {
                    spikeLog.text = "[spike] Reconnecting...\n" + spikeLog.text
                    streamView.source = ""
                    reconnectTimer.start()
                }
            }
        }

        Timer {
            id: reconnectTimer
            interval: 200
            onTriggered: streamView.source = root.spikeUrl
        }
    }
}
```

CRITICAL implementation notes:
- `cache: false` is MANDATORY — default `cache: true` holds stale frames (anti-pattern from RESEARCH.md)
- Reconnect MUST go through `source = ""` first, then use a Timer (200ms) before reassigning — synchronous same-URL reassignment does NOT trigger reload (Pitfall 5 from RESEARCH.md)
- The `spikeUrl` must be edited by the user to point to their real Frigate instance before testing — leave the placeholder with clear comments
- `?fps=5` query parameter limits frame rate to 5fps (reasonable for monitoring, reduces bandwidth)
- All colors use theme tokens (`Color.mSurface`, `Color.mPrimary`, `Color.mOnPrimary`, `Style.radiusM`)
- The spike log is temporary diagnostic UI that will be removed in Phase 4
  </action>
  <verify>
Verify Panel.qml spike implementation:
- File contains `cache: false`
- File contains `Image` component with `source: root.spikeUrl`
- File contains `reconnectTimer` with `interval: 200`
- File contains `streamView.source = ""` (the clear-before-reassign pattern)
- File contains `onStatusChanged` handler with Ready, Error, Loading cases
- File does NOT contain any hex color values (grep for `#[0-9a-fA-F]`)
- File does NOT contain `cache: true`
  </verify>
  <done>Panel.qml contains a complete MJPEG spike with Image component, status logging, and reconnect test button using theme-compliant colors</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify MJPEG spike behavior on target platform</name>
  <files>Panel.qml</files>
  <action>
CHECKPOINT: Human verification of MJPEG spike behavior. Claude has automated the spike implementation in Task 1. The user must now test on the target platform (niri + Quickshell + Qt6).

What was built: MJPEG streaming spike in Panel.qml with a hardcoded Frigate stream URL, status logging, and reconnect test button. The spike validates whether Qt6's Image component can handle multipart/x-mixed-replace MJPEG streams.

Pre-requisite: Edit `Panel.qml` and replace `FRIGATE_HOST` and `CAMERA_NAME` in the `spikeUrl` property with real Frigate instance values. Example: `http://192.168.1.100:5000/api/front_door?fps=5`

Install and test:

1. Symlink the plugin for development:
   `ln -sf /home/mariostjr/Documentos/Hubs/Plugin_Frigate ~/.config/noctalia/plugins/noctalia-frigate`

2. Restart Noctalia (or use hot-reload):
   `NOCTALIA_DEBUG=1 qs -c noctalia-shell --no-duplicate`

3. Enable the plugin: Settings > Plugins > enable "Frigate Viewer"
4. Add to bar: Settings > Bar > add "Frigate Viewer" widget

Test 1 — First frame: Click the camera icon in the bar. Panel opens (640x400). An image from the Frigate camera appears. Spike log shows "[spike] Frame loaded — status: Ready".

Test 2 — Continuous streaming: Keep panel open 30+ seconds. Image visually updates (motion or timestamp changes). If frozen on one frame, MJPEG continuous streaming is NOT working.

Test 3 — Reconnect: Click "Test Reconnect" button. Stream disappears then resumes within ~1 second. Spike log shows reconnecting then loading then frame loaded.

Test 4 — Panel toggle: Click bar icon to close, click again to reopen. Panel dismisses and reappears; icon opacity changes between open/closed states.

Report results as one of: "MJPEG GO" (all 3 tests pass), "MJPEG PARTIAL" (first frame displays but does NOT update continuously), "MJPEG NO-GO" (image never loads), or "BAR ISSUE: [description]" (bar/tooltip/panel problems). Include observations about latency, frame rate, or visual artifacts.
  </action>
  <verify>User has reported one of: "MJPEG GO", "MJPEG PARTIAL", "MJPEG NO-GO", or "BAR ISSUE" with observations</verify>
  <done>MJPEG spike has been tested on target platform and result reported by user</done>
</task>

<task type="auto">
  <name>Task 3: Document MJPEG spike result</name>
  <files>.planning/phases/01-plugin-skeleton-mjpeg-spike/01-SPIKE-RESULT.md</files>
  <action>
After the user reports the spike result from Task 2, create the spike result document at `.planning/phases/01-plugin-skeleton-mjpeg-spike/01-SPIKE-RESULT.md`.

Structure:

```markdown
# MJPEG Spike Result

**Date:** [execution date]
**Platform:** niri + Quickshell + Qt6 on Linux (CachyOS)
**Frigate version:** [from user if provided, or "not specified"]

## Result: [GO / PARTIAL / NO-GO]

## Test Results

| Test | Result | Notes |
|------|--------|-------|
| First frame display | [PASS/FAIL] | [observations] |
| Continuous streaming (30s+) | [PASS/FAIL] | [observations] |
| Reconnect (source="" + Timer) | [PASS/FAIL] | [observations] |

## Observations

[User's reported observations about latency, frame rate, visual artifacts]

## Impact on Phase 4

[If GO: Phase 4 proceeds with MJPEG streaming as primary strategy]
[If PARTIAL: Phase 4 uses snapshot polling as primary with MJPEG as experimental option]
[If NO-GO: Phase 4 uses snapshot polling exclusively — Timer + Image with timestamp cache-bust]
```

Fill in all fields based on the user's checkpoint report. This document is referenced by Phase 4 planning to decide the streaming strategy.
  </action>
  <verify>
- File exists at `.planning/phases/01-plugin-skeleton-mjpeg-spike/01-SPIKE-RESULT.md`
- File contains one of: "GO", "PARTIAL", or "NO-GO"
- File contains the test results table
- File contains "Impact on Phase 4" section
  </verify>
  <done>MJPEG spike result is documented with go/no-go determination, test results, and explicit impact statement for Phase 4 planning</done>
</task>

</tasks>

<verification>
After all tasks:
1. Panel.qml contains a working MJPEG spike with Image, cache:false, reconnect pattern
2. User has verified the spike on the target platform (checkpoint passed)
3. Spike result document exists and clearly states GO, PARTIAL, or NO-GO
4. Phase 4 impact is documented — no ambiguity about streaming strategy going forward
</verification>

<success_criteria>
- Panel.qml displays a live MJPEG stream from a hardcoded Frigate URL (or confirms it cannot)
- The three spike tests (first frame, continuous stream, reconnect) are executed and reported
- A spike result document exists that Phase 4 planning can reference for streaming strategy
- The biggest Phase 1 technical risk (MJPEG behavior on Qt6/Quickshell) is resolved
</success_criteria>

<output>
After completion, create `.planning/phases/01-plugin-skeleton-mjpeg-spike/01-02-SUMMARY.md`
</output>
